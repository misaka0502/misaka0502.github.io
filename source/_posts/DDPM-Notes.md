---
title: DDPM(Denoising Diffusion Probabilistic Models)è®ºæ–‡é˜…è¯»ç¬”è®°
date: 2024-12-04 23:23:01
tags: 
    - æ·±åº¦å­¦ä¹ 
    - Diffusion Model
mathjax: true
banner_img: /images/bg/emt1.png
---
<script src="https://fastly.jsdelivr.net/gh/misaka0502/live2d-widget@V0.2/autoload.js"></script>
<!-- <script src="/live2d-widget/autoload.js"></script> -->

# DDPM(Denoising Diffusion Probabilistic Models)è®ºæ–‡é˜…è¯»ç¬”è®°

> è®ºæ–‡ï¼š[Denoising Diffusion Probabilistic Models](https://arxiv.org/abs/2006.11239)
> 

# å‰è¨€

æœ€è¿‘åœ¨ç ”ç©¶Diffusion Policyï¼Œè·ŸDDPMå…³ç³»éå¸¸å¯†åˆ‡ï¼Œäºæ˜¯è¯»äº†ä¸‹DDPMçš„æ–‡ç« ï¼Œå†™ç¯‡ç¬”è®°ï¼Œé¡ºä¾¿æŒ–ä¸ªå‘ï¼Œè®°å½•ä¸€äº›ç”Ÿæˆæ¨¡å‹çš„ç ”ç©¶ã€‚DDPMï¼ˆä»¥ä¸‹ç®€ç§°æ‰©æ•£æ¨¡å‹ï¼‰ä¸ä»…åœ¨å›¾åƒç”Ÿæˆæ–¹é¢æœ‰ç€éå¸¸å¹¿æ³›çš„åº”ç”¨ï¼Œè€Œä¸”ç°åœ¨åœ¨æœºå™¨äººå­¦ä¹ ä¹Ÿæœ‰ç ”ç©¶å‰æ™¯ã€‚åœ¨è¯»äº†æ‰©æ•£æ¨¡å‹çš„è®ºæ–‡å’Œä¸€äº›è§£è¯»çš„åšå®¢åï¼Œå‘æ˜å…¶ä¸­æœ‰è®¸å¤šç»†èŠ‚éœ€è¦ä»”ç»†æ¢è®¨ã€‚ï¼ˆå®é™…è¿˜æœ‰å¾ˆå¤šç»†èŠ‚è¿˜æ²¡ç†è§£ğŸ¤¡ï¼‰

# ä»€ä¹ˆæ˜¯Diffusion Modelï¼ˆæ‰©æ•£æ¨¡å‹ï¼‰ï¼Ÿ

é¦–å…ˆéœ€è¦ç†æ¸…ä¸€ç‚¹ï¼Œå€Ÿç”¨[ç”Ÿæˆæ‰©æ•£æ¨¡å‹æ¼«è°ˆï¼ˆä¸€ï¼‰ï¼šDDPM = æ‹†æ¥¼ + å»ºæ¥¼](https://spaces.ac.cn/archives/9119/comment-page-1)ä¸€æ–‡æ‰€è¿°ï¼Œä¼ ç»Ÿçš„æ‰©æ•£æ¨¡å‹å®é™…ä¸Šæ˜¯ä¸€ç±»æ¨¡å‹ï¼Œæ¶‰åŠåˆ°èƒ½é‡æ¨¡å‹ï¼ˆEnergy-based Modelsï¼‰ã€å¾—åˆ†åŒ¹é…ï¼ˆScore Matchingï¼‰ã€æœ—ä¹‹ä¸‡æ–¹ç¨‹ï¼ˆLangevin Equationsï¼‰ç­‰ç­‰ï¼ŒDDPMä¹Ÿç”¨äº†â€œæ‰©æ•£æ¨¡å‹â€è¿™ä¸€åç§°ï¼Œä½†å®é™…ä¸Šé™¤äº†é‡‡æ ·è¿‡ç¨‹çš„å½¢å¼æœ‰ä¸€å®šç›¸ä¼¼å¤„å¤–ï¼ŒDDPMä¸ä¼ ç»ŸåŸºäºæœ—ä¹‹ä¸‡æ–¹ç¨‹é‡‡æ ·çš„æ‰©æ•£æ¨¡å‹å¯ä»¥è¯´å®Œå…¨ä¸ä¸€æ ·ï¼Œä¼ ç»Ÿçš„æ‰©æ•£æ¨¡å‹çš„èƒ½é‡æ¨¡å‹ã€å¾—åˆ†åŒ¹é…ã€æœ—ä¹‹ä¸‡æ–¹ç¨‹ç­‰æ¦‚å¿µï¼Œå…¶å®è·ŸDDPMåŠå…¶åç»­å˜ä½“éƒ½æ²¡ä»€ä¹ˆå…³ç³»ã€‚

![image.png](/images/ddpm_1.png)

æ‰©æ•£æ¨¡å‹çš„æ ¸å¿ƒæ˜¯ä¸¤ä¸ªè¿‡ç¨‹/æ¦‚å¿µï¼š**å‰å‘è¿‡ç¨‹ï¼ˆåŠ å™ªè¿‡ç¨‹ã€æ‰©æ•£è¿‡ç¨‹ï¼‰å’Œåå‘è¿‡ç¨‹ï¼ˆå»å™ªè¿‡ç¨‹ï¼‰**ã€‚ç›´ç™½ç†è§£ï¼Œå‰å‘è¿‡ç¨‹å°±æ˜¯**é€æ­¥**åœ°å¾€ä¸€å¼ å®Œå¥½çš„å›¾åƒé‡Œæ·»åŠ å™ªå£°ï¼Œè®©å…¶é€æ¸é è¿‘é«˜æ–¯å™ªå£°ï¼Œæ•´ä¸ªè¿‡ç¨‹å¯ä»¥è¡¨ç¤ºä¸ºï¼š

$$
x=x_0 \to x_1 \to x_2 \to Â·Â·Â· \to x_{T-1} \to x_T=z \tag{1}
$$

ç°åœ¨åœ¨å‰å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬çŸ¥é“æ¯ä¸€æ­¥åŠ å™ªçš„è¿‡ç¨‹ï¼Œå³$x_{t-1} \to x_{t}$ï¼Œå¦‚æœæˆ‘ä»¬èƒ½é€šè¿‡æŸç§æ–¹å¼æ‰¾åˆ°å…¶å¯¹åº”çš„åå‘è¿‡ç¨‹ï¼Œå³$x_t \to x_{t-1}$ï¼Œå°†è¿™ç§å˜æ¢å…³ç³»è®°ä½œ$x_{t-1}=\mu(x_t)$ï¼Œåå¤åœ°æ‰§è¡Œ$x_{T-1}=\mu(x_T)ã€x_{T-2}=\mu(x_{T-1}) Â·Â·Â·$ï¼Œæ˜¯ä¸æ˜¯å°±èƒ½**é€æ­¥**åœ°ä»$x_T$è¿˜åŸå›åŸå§‹çš„å›¾åƒ$x_0$ï¼Ÿ

ä»¥ä¸Šå°±æ˜¯æ‰©æ•£æ¨¡å‹æœ€æ ¸å¿ƒçš„æ€æƒ³ã€‚

è¿™é‡Œé¦–å…ˆè¦è¡¥å……ä¸€ä¸ªé‡è¦ç‰¹æ€§ï¼š

## é‡å‚æ•°ï¼ˆR**eparameterization**ï¼‰

é‡å‚æ•°æŠ€å·§åœ¨å¾ˆå¤šå·¥ä½œä¸­æœ‰æ‰€å¼•ç”¨ã€‚å¦‚æœæˆ‘ä»¬è¦ä»æŸä¸ªåˆ†å¸ƒä¸­éšæœºé‡‡æ · (é«˜æ–¯åˆ†å¸ƒ) ä¸€ä¸ªæ ·æœ¬ï¼Œ**è¿™ä¸ªè¿‡ç¨‹æ˜¯æ— æ³•åä¼ æ¢¯åº¦çš„**ã€‚è€Œè¿™ä¸ªé€šè¿‡é«˜æ–¯å™ªå£°é‡‡æ ·å¾—åˆ°$x_t$çš„è¿‡ç¨‹åœ¨ diffusion ä¸­åˆ°å¤„éƒ½æ˜¯ï¼Œå› æ­¤æˆ‘ä»¬éœ€è¦é€šè¿‡é‡å‚æ•°æŠ€å·§æ¥ä½¿å¾—ä»–å¯å¾®ã€‚

æœ€é€šå¸¸çš„åšæ³•æ˜¯æŠŠéšæœºæ€§é€šè¿‡ä¸€ä¸ªç‹¬ç«‹çš„éšæœºå˜é‡ (Ïµ) å¼•å¯¼è¿‡å»ã€‚å³å¦‚æœè¦ä»é«˜æ–¯åˆ†å¸ƒ$z\thicksim\mathcal{N}(z;\mu_\theta,\sigma^2_\theta \mathbf{I})$é‡‡æ ·ä¸€ä¸ª$z$ï¼Œæˆ‘ä»¬å¯ä»¥å†™æˆï¼š

$$
z=\mu_\theta+\sigma_\theta \odot \epsilon,\quad \epsilon \thicksim\mathcal{N}(0,\mathbf{I})
$$

ä¸Šå¼çš„$z$ä¾æ—§æ˜¯æœ‰éšæœºæ€§çš„ï¼Œä¸”æ»¡è¶³å‡å€¼ä¸º$\mu_\theta$ï¼Œæ–¹å·®ä¸º$\sigma^2_\theta$çš„é«˜æ–¯åˆ†å¸ƒã€‚è¿™é‡Œçš„$\mu_\theta$ï¼Œ$\sigma^2_\theta$å¯ä»¥æ˜¯ç”±å‚æ•°$\theta$çš„ç¥ç»ç½‘ç»œæ¨æ–­å¾—åˆ°çš„ã€‚æ•´ä¸ªé‡‡æ ·è¿‡ç¨‹ä¾æ—§æ¢¯åº¦å¯å¯¼ï¼Œéšæœºæ€§è¢«è½¬å«åˆ°äº†$\epsilon$ä¸Šã€‚

# å‰å‘è¿‡ç¨‹ ï¼ˆ**Forward Diffusion Process**ï¼‰

é¦–å…ˆå£°æ˜å‡ ä¸ªç¬¦å·çš„å…³ç³»ï¼šä»¤$\alpha_t=1-\beta_t,\bar{\alpha_t}=\prod^{t}_{i=1}\alpha_i$

DDPMå°†å‰å‘è¿‡ç¨‹å»ºæ¨¡ä¸º

$$
x_t=\sqrt{\alpha_t}x_{t-1}+\sqrt{\beta_t}\epsilon_t,\quad \epsilon_t \thicksim \mathcal{N}(0, 1)  \tag{2}
$$

è¿™ä¸ªå…¬å¼å°±æ˜¯ä¸€æ­¥æ­¥ç»™å›¾åƒæ·»åŠ å™ªå£°çš„å…¬å¼ã€‚

$\beta_t$é€šå¸¸å¾ˆæ¥è¿‘0ï¼Œå¯ä»¥ç†è§£ä¸ºåŠ å™ªè¿‡ç¨‹ä¸­å¯¹åŸå›¾åƒçš„æŸåç¨‹åº¦ï¼Œå™ªå£°$\epsilon_t$çš„å¼•å…¥ä»£è¡¨ç€å¯¹åŸå§‹ä¿¡å·çš„ä¸€ç§ç ´åï¼Œå¼•ç”¨è®ºæ–‡çš„åŸè¯ï¼š

> The forward process variances $\beta_t$ can be learned by reparameterization or held constant as hyperparameters, and expressiveness of the reverse process is ensured in part by the choice of Gaussian conditionals in  $p_{\theta}(x_{t-1}|x_t)$ï¼Œ because both processes have the same functional form when  $\beta_t$  are small.
æ­£å‘è¿‡ç¨‹æ–¹å·® $\beta_t$ å¯ä»¥é€šè¿‡é‡æ–°å‚æ•°åŒ–æ¥å­¦ä¹ ï¼Œæˆ–è€…ä½œä¸ºè¶…å‚æ•°ä¿æŒä¸å˜ï¼Œè€Œé€†è¿‡ç¨‹çš„è¡¨è¾¾èƒ½åŠ›éƒ¨åˆ†ç”± $p_{\theta}(x_{t-1}|x_t)$ä¸­é«˜æ–¯æ¡ä»¶çš„é€‰æ‹©æ¥ä¿è¯ï¼Œ**å› ä¸ºå½“ $\beta_t$ å¾ˆå°æ—¶ï¼Œä¸¤ä¸ªè¿‡ç¨‹å…·æœ‰ç›¸åŒçš„å‡½æ•°å½¢å¼ã€‚**
è¿™é‡Œçš„ $p_{\theta}(x_{t-1}|x_t)$åé¢ä¼šè®²åˆ°
> 

è¿™ä¸ªå‰å‘è¿‡ç¨‹ä¹Ÿå¯ä»¥ç”¨

$$
q(x_t|x_{t-1})=\mathcal{N}(x_t;\sqrt{\alpha_t}x_{t-1},(1-\alpha_t)\mathbf{I}) \tag{3}
$$

æ¥è¡¨ç¤ºï¼Œä¹Ÿè¢«ç§°ä¸ºâ€œè¿‘ä¼¼åéªŒâ€ï¼ˆapproximate posteriorï¼‰ï¼Œæ•´ä¸ªå‰å‘è¿‡ç¨‹ç¬¦åˆé©¬å°”å¯å¤«æ€§è´¨ï¼Œæ˜¯ä¸€ä¸ªé©¬å°”ç§‘å¤«é“¾ã€‚

å›¾ç¤ºï¼š

![image.png](/images/ddpm_2.png)

åå¤æ‰§è¡ŒåŠ å™ªæ­¥éª¤ï¼Œæˆ‘ä»¬å¯ä»¥æ¨å¯¼ï¼š

![image.png](/images/ddpm_3.png)

è¿™æ˜¯å‰å‘è¿‡ç¨‹ä¸­çš„å…³é”®æ€§è´¨ã€‚ä¹Ÿå¯ä»¥è¡¨ç¤ºä¸ºï¼š

$$
q(x_t|x_0)=\mathcal{N}(x_t;\sqrt{\bar{\alpha_t}}x_0,(1-\bar{\alpha_t})\mathbf{I}) \tag{4}
$$

è¿™è¢«ç§°ä¸º**Close formã€‚**

ä»è¿™ä¸ªå½¢å¼ï¼Œæˆ‘ä»¬å¯ä»¥å¾—å‡ºä¸¤ä¸ªç»“è®ºï¼š

- ä»»æ„æ—¶åˆ»çš„$x_t$å¯ä»¥ç”±$x_0$å’Œ$\beta$è¡¨ç¤ºï¼Œè¿™å°±ä¸ºè®¡ç®—$x_t$æä¾›äº†æå¤§çš„ä¾¿åˆ©ã€‚
- é€šè¿‡é€‰æ‹©åˆé€‚çš„$\alpha_t$ï¼ˆè®ºæ–‡é‡Œæ˜¯äººä¸ºè®¾ç½®$\beta_t$ï¼‰ï¼Œå½“æ—¶é—´æ­¥$T\to \infty$æ—¶ï¼Œ$\bar{\alpha_t} \to 0$ï¼Œ$x_T$å®é™…ä¸Šä¼šè¢«è½¬æ¢ä¸ºé«˜æ–¯å™ªå£°ã€‚

ä»¥ä¸Šå°±æ˜¯å‰å‘è¿‡ç¨‹ï¼Œä¸æ¶‰åŠåˆ°è®­ç»ƒã€‚

# åå‘è¿‡ç¨‹ ï¼ˆ**Reverse Diffusion Process**ï¼‰

å¦‚æœæŠŠå‰å‘è¿‡ç¨‹è§†ä½œâ€œåŠ å™ªâ€è¿‡ç¨‹ï¼Œé‚£ä¹ˆåå‘è¿‡ç¨‹å°±æ˜¯â€œå»å™ªâ€è¿‡ç¨‹ï¼Œå³$x_{t-1} \to x_t$çš„è¿‡ç¨‹ã€‚

![image.png](/images/ddpm_4.png)

åœ¨å‰å‘è¿‡ç¨‹ä¸­ï¼Œ$q(x_t|x_{t-1})$æ˜¯å·²çŸ¥çš„ï¼Œå¦‚æœèƒ½æ±‚è§£ç›®æ ‡åˆ†å¸ƒ$q(x_{t-1}|x_{t})$ï¼Œè¿™ä¸ªé—®é¢˜æ•‘è¿åˆƒè€Œè§£äº†ã€‚ç„¶è€Œï¼Œæˆ‘ä»¬æ— æ³•ç®€å•æ¨æ–­$q(x_{t-1}|x_{t})$ã€‚å› æ­¤æ¢ä¸ªæ€è·¯ï¼Œæˆ‘ä»¬çŸ¥é“ç¥ç»ç½‘ç»œæ˜¯é€šç”¨å‡½æ•°è¿‘ä¼¼å™¨ï¼Œå¯ä»¥åˆ©ç”¨ç¥ç»ç½‘ç»œå»é¢„æµ‹ä¸€ä¸ªåå‘çš„è¿‡ç¨‹$p_\theta(x_{t-1}|x_{t})$ï¼Œä½†æ˜¯è¦æ€ä¹ˆé¢„æµ‹ã€æ€ä¹ˆè®­ç»ƒï¼Ÿè¿™æ˜¯åå‘è¿‡ç¨‹çš„æ ¸å¿ƒé—®é¢˜ã€‚

å·²ç»æœ‰æ–‡çŒ®è¯æ˜ï¼Œå¦‚æœ$q(x_t|x_{t-1})$æ»¡è¶³é«˜æ–¯åˆ†å¸ƒä¸”**$\beta_t$**è¶³å¤Ÿå°ï¼Œ$q(x_{t-1}|x_{t})$ä»ç„¶æ˜¯ä¸€ä¸ªé«˜æ–¯åˆ†å¸ƒã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥å‡å®š$p_\theta(x_{t-1}|x_{t})$ä¹Ÿæ˜¯ä¸€ä¸ªé«˜æ–¯åˆ†å¸ƒï¼š

$$
p_\theta(x_{t-1}|x_t)=\mathcal{N}(x_{t-1};\mu_\theta(x_t,t),\Sigma_\theta(x_t,t)) \tag{5}
$$

å‰é¢è¯´åˆ°ï¼Œåå‘è¿‡ç¨‹æ˜¯è®­ç»ƒä¸€ä¸ªç½‘ç»œ$p_\theta(x_{t-1}|x_{t})$å»é¢„æµ‹$q(x_{t-1}|x_{t})$ï¼Œä½†æ˜¯$q(x_{t-1}|x_{t})$æˆ‘ä»¬æ— æ³•ç›´æ¥å¾—åˆ°ï¼Œé‚£ä¹ˆè¯¥æ€ä¹ˆè®­ç»ƒï¼Ÿè¿™é‡Œå¼•å…¥äº†ä¸€ä¸ªå¾ˆå·§å¦™çš„æ–¹æ³•ï¼Œé‚£å°±æ˜¯æˆ‘ä»¬ä¸å»æ‰¾$q(x_{t-1}|x_{t})$ï¼Œè€Œæ˜¯æ‰¾$q(x_{t-1}|x_{t},x_0)$ï¼ŒæŠŠæ¡ä»¶åˆ†å¸ƒå˜æˆè”åˆåˆ†å¸ƒã€‚ç”±äºå‰å‘è¿‡ç¨‹ç¬¦åˆé©¬å°”å¯å¤«æ€§è´¨ï¼Œæ‰€ä»¥è¿™ä¸¤ä¸ªä¸œè¥¿å®é™…æ˜¯ç­‰ä»·çš„ï¼Œä½†æ˜¯åè€…æ˜¯å¯ä»¥é€šè¿‡è´å¶æ–¯å…¬å¼æ¨å¯¼å¾—åˆ°çš„ï¼Œæ¨å¯¼è¿‡ç¨‹å¦‚ä¸‹ï¼š

$$
q(x_{t-1}|x_t,x_0)=\frac{q(x_t,x_0,x_{t-1})}{q(x_t,x_0)} \\
=\frac{q(x_0)q(x_{t-1}|x_0)q(x_t|x_{t-1},x_0)}{q(x_0)q(x_t|x_0)} \\
=q(x_t|x_{t-1},x_0)\frac{q(x_{t-1}|x_0)}{q(x_t|x_0)} \tag{6}
$$

è‡³æ­¤ï¼Œå°†åå‘è¿‡ç¨‹å…¨éƒ¨å˜å›äº†æ­£å‘è¿‡ç¨‹ï¼Œè€Œæ­£å‘è¿‡ç¨‹æˆ‘ä»¬æ˜¯çŸ¥é“çš„ï¼Œè¿™é‡Œçš„æ¯ä¸€é¡¹éƒ½å¯ä»¥æ±‚ã€‚

> è¿™é‡Œæœ‰ä¸€ä¸ªå®¹æ˜“ç»•æ™•çš„ç‚¹ï¼ˆæˆ‘è‡ªå·±ä¸€å¼€å§‹ä¹Ÿç»•æ™•äº†ï¼‰ï¼Œæ—¢ç„¶åå‘è¿‡ç¨‹éƒ½å·²ç»è¡¨ç¤ºå‡ºæ¥äº†ï¼Œä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥ç”¨å‘¢ï¼Ÿå› ä¸ºè¿™é‡Œè®¨è®ºçš„æ˜¯è®­ç»ƒè¿‡ç¨‹ï¼Œ$x_0$æˆ‘ä»¬æ˜¯çŸ¥é“çš„ï¼Œè€Œæ¨ç†æ—¶$x_0$æ˜¯ä¸çŸ¥é“çš„ã€‚
> 

å¼ï¼ˆ7ï¼‰ä¸­çš„å„é¡¹ä¹Ÿéƒ½æ˜¯ç¬¦åˆé«˜æ–¯åˆ†å¸ƒçš„ï¼Œå¦‚ä¸‹ï¼š

![image.png](/images/ddpm_5.png)

å› æ­¤ï¼Œå¼ï¼ˆ7ï¼‰å¯ä»¥ç»§ç»­å¾€ä¸‹æ¨å¯¼ï¼ˆæ¨å¯¼è¿‡ç¨‹çœç•¥äº†ï¼Œå¯ä»¥é€šè¿‡é«˜æ–¯åˆ†å¸ƒçš„è¡¨è¾¾å¼æ¨ï¼Œç›´æ¥ç»™å‡ºç»“æœï¼‰ï¼š

$$
q(x_{t-1}|x_t,x_0)=\mathcal{N}(x_{t-1},\frac{\sqrt{\alpha_t}(1-\bar{\alpha}_{t-1})x_t+\sqrt{\bar{\alpha}_{t-1}}(1-\alpha_t)x_0}{1-\bar{\alpha}_t},\frac{(1-\alpha_t)(1-\bar{\alpha}_{t-1})}{1-\bar{\alpha}_t}\mathbf{I}) \tag{7}
$$

åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬ä»¤$\tilde{\mu}_t(x_t,x_0)=\frac{\sqrt{\alpha_t}(1-\bar{\alpha}_{t-1})x_t+\sqrt{\bar{\alpha}_{t-1}}(1-\alpha_t)x_0}{1-\bar{\alpha}_t}$ï¼Œ$\tilde{\beta}_t=\frac{(1-\alpha_t)(1-\bar{\alpha}_{t-1})}{1-\bar{\alpha}_t}$ã€‚

ç”±äº$\beta_1,\beta_2Â·Â·Â·\beta_t$å¯ä»¥æ˜¯è®­ç»ƒæ—¶äººä¸ºè®¾ç½®çš„ä¸€ç»„è¶…å‚æ•°ï¼Œæ‰€ä»¥è¿™é‡Œ$\tilde{\beta}_t$å¯ä»¥è§†ä¸ºä¸€ä¸ªå¸¸æ•°ã€‚å› æ­¤ï¼Œè®­ç»ƒçš„å…³é”®å…¶å®è½åœ¨äº†å¦‚ä½•é¢„æµ‹$\tilde{\mu}_t(x_t,x_0)$ã€‚

ç”±Close-Formå¯ä»¥æ±‚å‡ºï¼š

$$
x_{0}=\frac{1}{\sqrt{\bar{\alpha}_t}}(x_t-\sqrt{1-\bar{\alpha}_t}\epsilon_t) \tag{8}
$$

å°†å¼ï¼ˆ8ï¼‰ä»£å…¥å¼ï¼ˆ7ï¼‰ä¸­ï¼Œå¯ä»¥å°†$\tilde{\mu}_t(x_t,x_0)$åŒ–ç®€ä¸ºï¼š

$$
\tilde{\mu}_t(x_t,x_0)=\frac{1}{\sqrt{\alpha_t}}(x_t-\frac{1-\alpha_t}{\sqrt{1-\bar{\alpha}_t}}\epsilon_\theta(x_t,t)) \tag{9}
$$

è¿™ä¸ªå¼å­ä¸­ï¼Œä¹Ÿåªæœ‰$\epsilon_t$æ˜¯æœªçŸ¥çš„ï¼Œå› æ­¤ï¼Œæˆ‘ä»¬å®é™…ä¸Šæ˜¯éœ€è¦ç¥ç»ç½‘ç»œå»é¢„æµ‹ä¸€ä¸ªâ€œ**å™ªå£°**â€ã€‚

åœ¨è®­ç»ƒå¥½ç½‘ç»œåï¼Œæˆ‘ä»¬å°±å¯ä»¥é€šè¿‡å‰æ–‡æåˆ°çš„é‡å‚æ•°ä»$x_T$å»ä¸€æ­¥æ­¥**é‡‡æ ·**å¾—åˆ°$x_0$ï¼š

$$
x_{t-1}=\frac{1}{\sqrt{\alpha_t}}(x_t-\frac{1-\alpha_t}{\sqrt{1-\bar{\alpha}_t}}\epsilon_\theta(x_t,t))+\sigma_tz \tag{10}
$$

ä¸ºäº†è¿›è¡Œéšæœºé‡‡æ ·ï¼Œè¿™é‡Œçš„æœ€åæœ‰ä¸€ä¸ªé«˜æ–¯é¡¹ã€‚

ä»¥ä¸Šå°±æ˜¯åå‘è¿‡ç¨‹ï¼Œæ ¸å¿ƒå°±æ˜¯è®¾è®¡ä¸€ä¸ªç¥ç»ç½‘ç»œå»é¢„æµ‹åˆ†å¸ƒ$q(x_{t-1}|x_t,x_0)$çš„å‡å€¼$\mu_\theta(x_t,t)$ï¼Œè€Œé¢„æµ‹å‡å€¼å®é™…ä¸Šæ˜¯é€šè¿‡é¢„æµ‹å™ªå£°$\epsilon_\theta(x_t,t)$å®ç°çš„ã€‚

æ€»ç»“åå‘è¿‡ç¨‹ï¼š

1. æ¯ä¸ªæ—¶é—´æ­¥é€šè¿‡$x_t$å’Œ$t$æ¥é¢„æµ‹é«˜æ–¯å™ªå£°$\epsilon_\theta(x_t,t)$ï¼Œéšåæ ¹æ®å¼ï¼ˆ9ï¼‰å¾—åˆ°å‡å€¼$\mu_\theta(x_t,t)$
2. å¾—åˆ°æ–¹å·®$\Sigma_\theta(x_t,t)$ï¼Œåœ¨DDPMä¸­ä½¿ç”¨untrained$\Sigma_\theta(x_t,t)=\tilde{\beta}_t$ï¼Œä¸”è®¤ä¸º$\tilde{\beta}_t=\beta_t$å’Œ$\tilde{\beta}_t=\frac{1-\overline{\alpha}_{t-1}}{1-\overline{\alpha}_t}Â·\beta_t$ç»“æœè¿‘ä¼¼
3. æ ¹æ®å¼ï¼ˆ5ï¼‰å¾—åˆ°$q(x_{t-1}|x_t)$ï¼Œåˆ©ç”¨é‡å‚æ•°å¾—åˆ°$x_{t-1}$

# è®­ç»ƒè¿‡ç¨‹

## ä¼˜åŒ–ç›®æ ‡â€”â€”æœ€å¤§ä¼¼ç„¶ä¼°è®¡

è¿™é‡Œå…¶å®æˆ‘æ²¡çœ‹æ‡‚ï¼Œç®€å•è®°å½•ä¸€äº›å¼å­ï¼Œç­‰ä»¥åçœ‹æ‡‚äº†ç»§ç»­è¡¥å……ã€‚

è®ºæ–‡åŸè¯ï¼šTraining is performed by optimizing the usual variational bound on negative log likelihood.

$$
\mathbb{E}\left[-\log p_\theta(\mathbf{x}_0)\right]\leq\mathbb{E}_q\left[-\log\frac{p_\theta(\mathbf{x}_{0:T})}{q(\mathbf{x}_{1:T}|\mathbf{x}_0)}\right] \\
=\mathbb{E}_q\left[-\log p(\mathbf{x}_T)-\sum_{t\geq1}\log\frac{p_\theta(\mathbf{x}_{t-1}|\mathbf{x}_t)}{q(\mathbf{x}_t|\mathbf{x}_{t-1})}\right]=:L \tag{11}
$$

ä¸‹é¢åˆ†æä¸€ä¸‹ã€‚å®é™…ä¸Šè¿™æ˜¯åœ¨ä¼˜åŒ–$x_0 \thicksim q(x_0)$ä¸‹çš„$p_\theta(x_0)$äº¤å‰ç†µï¼š

$$
\mathcal{L}=\Bbb{E}_{q(x_0)}[-logp_\theta(x_0)] \tag{12}
$$

å¯ä»¥ä½¿ç”¨å˜åˆ†ä¸‹ç•Œï¼ˆVLBï¼‰æ¥ä¼˜åŒ–è´Ÿå¯¹æ•°ä¼¼ç„¶ã€‚ç”±äºKLæ•£åº¦éè´Ÿï¼Œå¯å¾—åˆ°ï¼š

$$
\begin{aligned}-\log p_\theta(x_0) & \leq-\log p_\theta(x_0)+D_{KL}(q(x_{1:T}|x_0)||p_\theta(x_{1:T}|x_0)) \\ & =-\log p_\theta(x_0)+\mathbb{E}_{q(x_{1:T}|x_0)}\left[\log\frac{q(x_{1:T}|x_0)}{p_\theta(x_{0:T})/p_\theta(x_0)}\right];\quad\mathrm{~where~}\quad p_\theta(x_{1:T}|x_0)=\frac{p_\theta(x_{0:T})}{p_\theta(x_0)} \\ & =-\log p_\theta(x_0)+\mathbb{E}_{q(x_{1:T}|x_0)}\left[\log\frac{q(x_{1:T}|x_0)}{p_\theta(x_{0:T})}+\underbrace{\log p_\theta(x_0)}_{\text{ä¸}q\text{æ— å…³}}\right] \\ & =\mathbb{E}_{q(x_{1:T}|x_0)}\left[\log\frac{q(x_{1:T}|x_0)}{p_\theta(x_{0:T})}\right].  \end{aligned} \tag{13}
$$

è¿™å°±æ˜¯ELBOï¼ˆè¯æ®ä¸‹ç•Œ/å˜åˆ†ä¸‹ç•Œï¼‰ã€‚å¯¹å·¦å³å–æœŸæœ›$\Bbb{E}_{q(x_0)}$ï¼Œåˆ©ç”¨é‡ç§¯åˆ†ä¸­çš„Fubiniå®šç†ï¼Œå¯ä»¥å¾—åˆ°ï¼š

$$
\mathcal{L}_{VLB}=\underbrace{\mathbb{E}_{q(x_0)}\left(\mathbb{E}_{q(x_{1:T}|x_0)}\left[\log\frac{q(x_{1:T}|x_0)}{p_\theta(x_{0:T})}\right]\right)=\mathbb{E}_{q(x_{0:T})}\left[\log\frac{q(x_{1:T}|x_0)}{p_\theta(x_{0:T})}\right]}_{Fubini\text{å®šç†}} \\
\geq\mathbb{E}_{q(x_0)}[-\log p_\theta(x_0)]. \tag{14}
$$

èƒ½å¤Ÿæœ€å°åŒ–$\mathcal{L}_{VLB}$å³å¯æœ€å°åŒ–æˆ‘ä»¬çš„ç›®æ ‡æŸå¤±(11)ã€‚

è¿›ä¸€æ­¥å¯¹$\mathcal{L}_{VLB}$æ¨å¯¼ï¼Œå¯ä»¥å¾—åˆ°ç†µä¸å¤šä¸ªKLæ•£åº¦çš„ç´¯åŠ ï¼Œå…·ä½“å¯è§æ–‡çŒ®ã€ã€‘ä¸­çš„æ¨å¯¼ã€‚è¿™é‡Œç›´æ¥ç»™å‡ºç»“æœï¼š

$$
\mathbb{E}_q\left[\underbrace{D_{\mathrm{KL}}(q(\mathbf{x}_T|\mathbf{x}_0)\parallel p(\mathbf{x}_T))}_{L_T}+\sum_{t>1}\underbrace{D_{\mathrm{KL}}(q(\mathbf{x}_{t-1}|\mathbf{x}_t,\mathbf{x}_0)\parallel p_\theta(\mathbf{x}_{t-1}|\mathbf{x}_t))}_{L_{t-1}}\underbrace{-\log p_\theta(\mathbf{x}_0|\mathbf{x}_1)}_{L_0}\right] \tag{15}
$$

ç”±äºå‰å‘qæ²¡æœ‰å¯å­¦ä¹ çš„å‚æ•°ï¼Œè€Œ$x_T$åˆ™æ˜¯çº¯é«˜æ–¯å™ªå£°ï¼Œ$L_T$å¯ä»¥å½“ä½œå¸¸é‡å¿½ç•¥ã€‚è€Œ$L_t$åˆ™å¯ä»¥çœ‹ä½œæ‹‰è¿‘2ä¸ªé«˜æ–¯åˆ†å¸ƒ

$q(x_{t-1}|x_t,x_0)=\mathcal{N}(x_{t-1;}\tilde{\mu}(x_t,x_0),\tilde{\beta}_{t}\mathbf{I})$å’Œ$p_\theta(x_{t-1}|x_t)=\mathcal{N}(x_{t-1},\mu_\theta(x_t,t),\Sigma_\theta)$ï¼Œæ ¹æ®å¤šå…ƒé«˜æ–¯åˆ†å¸ƒçš„KLæ•£åº¦æ±‚è§£ï¼š

$$
L_{t-1}=\mathbb{E}_{q}\left[\frac{1}{2 \sigma_{t}^{2}}\left\|\tilde{\boldsymbol{\mu}}_{t}\left(\mathbf{x}_{t}, \mathbf{x}_{0}\right)-\boldsymbol{\mu}_{\theta}\left(\mathbf{x}_{t}, t\right)\right\|^{2}\right]+C \tag{16}
$$

DDPMåœ¨è®­ç»ƒæ—¶ä½¿ç”¨çš„æ˜¯ä»¥ä¸‹å˜ä½“ï¼š

$$
L_{\mathrm{simple}}(\theta):=\mathbb{E}_{t,\mathbf{x}_{0},\boldsymbol{\epsilon}}\left[\left\|\epsilon-\epsilon_{\theta}(\sqrt{\bar{\alpha}_{t}}\mathbf{x}_{0}+\sqrt{1-\bar{\alpha}_{t}}\boldsymbol{\epsilon},t)\right\|^{2}\right] \tag{17}
$$

æ€»ç»“è®­ç»ƒè¿‡ç¨‹ï¼š

1. è·å–è¾“å…¥$x_0$ï¼Œä»$1...T$éšæœºé‡‡æ ·ä¸€ä¸ªt
2. ä»æ ‡å‡†é«˜æ–¯åˆ†å¸ƒé‡‡æ ·ä¸€ä¸ªå™ªå£°$\epsilon_t\thicksim \cal{N}(0,\mathbf{I})$
3. æœ€å°åŒ–$||\epsilon_t-\epsilon_\theta(\sqrt{\bar{\alpha}}_tx_0+\sqrt{1-\bar{\alpha}_t}\epsilon_t,t)||$

![image.png](/images/ddpm_6.png)

# é‡è¦å…¬å¼æ€»ç»“

1. forwardï¼ˆclose-formï¼‰ï¼š
   
    $$
    x_t=\sqrt{\bar{\alpha}_t}x_0+\sqrt{1-\bar{\alpha}_t}\epsilon
    $$
    
2. optimizationï¼š
   
    $$
    L_{\mathrm{simple}}(\theta):=\mathbb{E}_{t,\mathbf{x}_{0},\boldsymbol{\epsilon}}\left[\left\|\epsilon-\epsilon_{\theta}(\sqrt{\bar{\alpha}_{t}}\mathbf{x}_{0}+\sqrt{1-\bar{\alpha}_{t}}\boldsymbol{\epsilon},t)\right\|^{2}\right]
    $$
    
3. reverseï¼š
   
    $$
    q(x_{t-1}|x_t,x_0)=\mathcal{N}(x_{t-1},\frac{\sqrt{\alpha_t}(1-\bar{\alpha}_{t-1})x_t+\sqrt{\bar{\alpha}_{t-1}}(1-\alpha_t)x_0}{1-\bar{\alpha}_t},\frac{(1-\alpha_t)(1-\bar{\alpha}_{t-1})}{1-\bar{\alpha}_t}\mathbf{I})
    $$
    
4. trainingï¼š
   
    $$
    \text{argmin}_{\theta} \frac{1}{2\sigma_q^2(t)} \langle \mu_\theta - \mu_q, \frac{1}{2} \rangle
    $$
    
    $$
    \text{argmin}_{\theta} \frac{1}{2\sigma_q^2(t)} \langle (1 - \alpha_t), \alpha_t \rangle \langle e_t, \epsilon_\theta(x_t, t) \rangle
    $$
    
5. samplingï¼š
   
    $$
    x_{t-1}=\frac{1}{\sqrt{\alpha_t}}(x_t-\frac{1-\alpha_t}{\sqrt{1-\bar{\alpha}_t}}\epsilon_\theta(x_t,t))+\sigma_tz
    $$
    

DDPMè®ºæ–‡æä¾›çš„è®­ç»ƒ/æµ‹è¯•ï¼ˆé‡‡æ ·ï¼‰ä¼ªä»£ç ï¼š

![image.png](/images/ddpm_7.png)

# å…¶ä»–ç»†èŠ‚

## é™ä½æ–¹å·®

åŸåˆ™ä¸Šæ¥è¯´ï¼Œä¼˜åŒ–æŸå¤±å‡½æ•°ï¼ˆ17ï¼‰å°±å¯ä»¥å®ŒæˆDDPMçš„è®­ç»ƒï¼Œä½†å®ƒåœ¨å®è·µä¸­å¯èƒ½æœ‰æ–¹å·®è¿‡å¤§çš„é£é™©ï¼Œä»è€Œå¯¼è‡´æ”¶æ•›è¿‡æ…¢ç­‰é—®é¢˜ã€‚å¼ï¼ˆ17ï¼‰ä¸­å®é™…åŒ…å«äº†4ä¸ªéœ€è¦é‡‡æ ·çš„éšæœºå˜é‡ï¼š

1. ä»æ‰€æœ‰è®­ç»ƒæ ·æœ¬ä¸­æ¬¡é‡‡æ ·ä¸€ä¸ª$x_0$
2. ä»æ­£æ€åˆ†å¸ƒ$\cal{N}(0,\mathbf{I})$ä¸­é‡‡æ ·$\epsilon_t$å’Œ$\epsilon_{t-1}$ï¼ˆä¸¤ä¸ªä¸åŒçš„é‡‡æ ·ç»“æœï¼‰
3. ä»$1 \thicksim T$ä¸­é‡‡æ ·ä¸€ä¸ª$t$

è¦é‡‡æ ·çš„éšæœºå˜é‡è¶Šå¤šï¼Œå°±è¶Šéš¾å¯¹æŸå¤±å‡½æ•°åšå‡†ç¡®çš„ä¼°è®¡ï¼Œåè¿‡æ¥è¯´å°±æ˜¯æ¯æ¬¡å¯¹æŸå¤±å‡½æ•°è¿›è¡Œä¼°è®¡çš„æ³¢åŠ¨ï¼ˆæ–¹å·®ï¼‰å¤ªå¤§äº†ã€‚å®é™…ä¸Šæˆ‘ä»¬å¯ä»¥é€šè¿‡å‡ ä¸ªç§¯åˆ†æŠ€å·§å°†$\epsilon_t$å’Œ$\epsilon_{t-1}$åˆå¹¶æˆå•ä¸ªæ­£æ€éšæœºå˜é‡ï¼Œä»è€Œç¼“è§£æ–¹å·®è¿‡å¤§çš„é—®é¢˜ã€‚è¿™ä¸€ç‚¹å°±ä¸è¯¦ç»†è®°å½•äº†ï¼Œå› ä¸ºæˆ‘æ²¡çœ‹æ‡‚ğŸ¥²

## é€’å½’ç”Ÿæˆï¼ˆé‡‡æ ·ï¼‰

è®­ç»ƒå®Œä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥ä»ä¸€ä¸ªéšæœºå™ªå£°$x_T \thicksim \cal{N}(0,\mathbf{I})$å‡ºå‘æ‰§è¡Œ$T$æ­¥é‡‡æ ·å…¬å¼ï¼ˆ10ï¼‰æ¥è¿›è¡Œç”Ÿæˆã€‚

> ä¸€èˆ¬æ¥è¯´ï¼Œæˆ‘ä»¬å¯ä»¥è®©$\sigma_t=\beta_t$ï¼Œå³æ­£å‘å’Œåå‘çš„æ–¹å·®ä¿æŒåŒæ­¥ã€‚è¿™ä¸ªé‡‡æ ·è¿‡ç¨‹è·Ÿä¼ ç»Ÿçš„æ‰©æ•£æ¨¡å‹çš„æœ—ä¹‹ä¸‡é‡‡æ ·ä¸ä¸€æ ·çš„åœ°æ–¹åœ¨äºï¼šDDPMçš„é‡‡æ ·æ¯æ¬¡éƒ½ä»ä¸€ä¸ªéšæœºå™ªå£°ä¹¦æ³•ï¼Œéœ€è¦é‡å¤è¿­ä»£$T$æ­¥æ¥å¾—åˆ°ä¸€ä¸ªæ ·æœ¬è¾“å‡ºï¼›æœ—ä¹‹ä¸‡é‡‡æ ·æ˜¯ä»ä»»æ„ä¸€ä¸ªç‚¹å‡ºå‘ï¼Œåç¬¦è¿­ä»£æ— é™æ­¥ï¼Œç†è®ºä¸Šè¿™ä¸ªè¿­ä»£æ— é™æ­¥çš„è¿‡ç¨‹ä¸­ï¼Œå°±æŠŠæ‰€æœ‰æ•°æ®æ ·æœ¬éƒ½ç”Ÿæˆè¿‡äº†ã€‚æ‰€ä»¥ä¸¤è€…é™¤äº†å½¢å¼ç›¸ä¼¼ä¹‹å¤–ï¼Œå®è´¨ä¸Šæ˜¯ä¸¤ä¸ªæˆªç„¶ä¸åŒè¿‡çš„æ¨¡å‹ã€‚
> 

![image.png](/images/ddpm_8.png)

## TODO

ç°åœ¨æ–‡ç« é‡Œç”¨çš„ç¬¦å·æœ‰ç‚¹ä¹±ï¼Œæ‰¾ä¸ªæ—¶é—´ç»Ÿä¸€ä¸€ä¸‹ã€‚

# å‚è€ƒæ–‡çŒ®

[Denoising Diffusion Probabilistic Models](https://arxiv.org/abs/2006.11239)

[ç”Ÿæˆæ‰©æ•£æ¨¡å‹æ¼«è°ˆï¼ˆä¸€ï¼‰ï¼šDDPM = æ‹†æ¥¼ + å»ºæ¥¼](https://spaces.ac.cn/archives/9119)

[ã€å¤§ç™½è¯01ã€‘ä¸€æ–‡ç†æ¸… Diffusion Model æ‰©æ•£æ¨¡å‹ | åŸç†å›¾è§£+å…¬å¼æ¨å¯¼](https://www.bilibili.com/video/BV1xih7ecEMb/?spm_id_from=333.337.search-card.all.click&vd_source=418a13a1dcf4b812b80b357e2cc44de8)

[ç”±æµ…å…¥æ·±äº†è§£Diffusion Model](https://zhuanlan.zhihu.com/p/525106459)